{% extends 'layouts/base.html' %}

{% load mptt_tags %}

{% block title %}{{ note.title }}{% endblock %}


{% block main %}
<div class="row" style="margin-top: 120px;">

  <!-- Title -->
  <p class="fs-3 text-center">{{ note.title }}</p>

  <!-- Summary -->
  <p class="text-secondary text-center">{{ note.summary }}</p>

  <!-- Note attributes -->
  <div class="d-flex bd-highlight mt-3 mb-3 fw-light">
    <div class="p-2 bd-highlight text-secondary">
      <span>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar3" viewBox="0 0 16 16">
          <path d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z"/>
          <path d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
        </svg>
        {{ note.date|date:"j M Y h:m" }}
      </span>
    </div>
    {% if not note.anonymous %}
      <div class="p-2 bd-highlight text-secondary">
        <a href="{% url 'notes:by_user' username=note.author %}" class="text-decoration-none">&nbsp;&nbsp;&nbsp;
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-lines-fill" viewBox="0 0 16 16">
            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/>
          </svg>
          {{ note.author }}â €
        </a>
      </div>
    {% endif %}
    <!-- Source -->
    {% if note.source %}
      <div class="p-2 bd-highlight">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-link-45deg" viewBox="0 0 16 16">
          <path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/>
          <path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/>
        </svg>
        <a href="{{ note.source }}" target="_blank">Source</a>
      </div>
    {% endif %}

    <!-- Anon/Private Badges -->
    {% if request.user == user %}
      {% if note.private %}
        <span class="badge badge-private ms-1 mb-1" style="max-height: 20px; margin-top: 10px;">Private</span>
      {% endif %}
      {% if note.anonymous %}
        <span class="badge badge-anon ms-1 mb-1" style="max-height: 20px; margin-top: 10px;">Anonymous</span>
      {% endif %}
    {% endif %}

    <!-- Control buttons (update/delete) -->
    <div class="ms-auto p-2 bd-highlight">
      {% if user == note.author %}
        <div class="d-flex justify-content-end">
          <form action="{% url 'update' slug=note.slug %}" method="get">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-info btn-sm">
              Edit Note
            </button>
          </form>
          <form action="{% url 'delete' slug=note.slug %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger btn-sm ms-2" onclick="return confirm('Are you sure?');">
              Delete Note
            </button>
          </form>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Tags -->
  <p class="d-flex flex-wrap" style="margin-top: 2px;">
    {% for tag in note.tags.all %}
      <a href="{% url 'tagged' tag_slug=tag.slug %}" class="badge tag-badge ms-1 mb-1">{{ tag }}</a>
    {% endfor %}
  </p>
</div>

<hr class="mt-2">

<!-- Body -->
<div class="row m-auto" style="max-width: 95%;">
  <div class="col-10 offset-1">
    <p>{{ note.body_html | safe }}</p>
  </div>
</div>


<!-- Comments -->
{% if note.allow_comments %}
<hr class="mt-2">

  <!-- general comment section -->
<form id="commentGeneralForm" class="m-auto" method="post">
  {{ comment_form.as_p }}
  {% csrf_token %}
  <button type="submit" class="btn btn-primary btn-block float-end px-4">Post</button>
</form>

  <!-- comments list -->
{% with comments=page_obj total_comments=note.comments.count %}
  <h4>{{ total_comments }} comment{{ total_comments|pluralize }}</h4>
  {% for root_comment in comments %}
    {% with children=root_comment.get_children total_children=root_comment.get_children.count %}
      <div>
        <p class="small m-auto pt-3"><a class="text-decoration-none text-dark" href="{% url 'notes:by_user' username=root_comment.author %}"><b>{{ root_comment.author }}</b></a>&nbsp;<spam class="text-secondary">{{ root_comment.date|date:'d M Y' }}</spam></p>
        <p class="m-auto">{{ root_comment.content }}</p>
        <button id="{{ root_comment.id }}" type="button" class="btn btn-link btn-sm text-decoration-none shadow-none"
          onclick="openCommentForm({{ root_comment.id }}, {{ root_comment.id }})">
          <b>REPLY</b>
        </button>
        {% if total_children %}
          <button type="button" class="btn btn-link text-decoration-none text-uppercase shadow-none" style="font-size: 15px;"
            onclick="expandChildren('childrenComments{{ root_comment.id }}', 'arrow{{ root_comment.id }}')">
            <span id="arrow{{ root_comment.id }}">&#9662;</span><b>&nbsp;&nbsp;{{ total_children }} ANSWER{{ total_children|pluralize }}</b>
          </button>
        {% endif %}
      </div>
      <div id="childrenComments{{ root_comment.id }}" hidden>
          {% for child in children %}
          <div class="children" style="margin-left: 40px;">
            <p class="small m-auto pt-3"><a class="text-decoration-none text-dark" href="{% url 'notes:by_user' username=child.author %}"><b>{{ child.author }}</b></a>&nbsp;<spam class="text-secondary">{{ child.date|date:'d M Y' }}</spam></p>
            <p class="m-auto">{{ child.content }}</p>
            <button id="{{ child.id }}" type="button" class="btn btn-link btn-sm text-decoration-none shadow-none"
              onclick="openCommentForm({{ child.parent.id }}, {{ child.id }})">
              <b>REPLY</b>
            </button>
          </div>
          {% endfor %}
        {% endwith %}
      </div>
  {% endfor %}
{% endwith %}

   <script>

    function expandChildren(children_div_id, arrow_id) {
      var element = document.getElementById(children_div_id);
      var arrow_span = document.getElementById(arrow_id);
      if (element.hidden == true) {
        element.hidden = false;
        arrow_span.innerText = 	'\u25B4';
      } else {
        element.hidden = true;
        arrow_span.innerText = '\u25BE';
      }
    }

    function openCommentForm(parent_id, id) {
      var csrf_token = document.getElementsByName('csrfmiddlewaretoken')[0]['defaultValue'];
      
      if (document.contains(document.getElementById('commentForm'))) {
        document.getElementById('commentForm').remove();
      }

      var comment_last_element = document.getElementById(id);
      comment_last_element.insertAdjacentHTML('afterend',
        '<form id="commentForm" class="m-auto" method="post"> \
          <p> \
              <select name="parent" class="d-none" required="" id="id_parent"> \
                <option value="' + parent_id + '" selected="' + parent_id + '"></option> \
              </select> \
          </p> \
              <p> <lt-mirror contenteditable="false" style="display: none;"><lt-highlighter contenteditable="false" style="display: none;"><lt-div spellcheck="false" class="lt-highlighter__wrapper" style="width: 694px !important; height: 60px !important; transform: none !important; transform-origin: 348px 31px !important; zoom: 1 !important; margin-top: 1px !important; margin-left: 1px !important;"><lt-div class="lt-highlighter__scroll-element" style="top: 0px !important; left: 0px !important; width: 694px !important; height: 60px !important;"></lt-div></lt-div></lt-highlighter><lt-div spellcheck="false" class="lt-mirror__wrapper notranslate" data-lt-scroll-top="0" data-lt-scroll-left="0" data-lt-scroll-top-scaled="0" data-lt-scroll-left-scaled="0" data-lt-scroll-top-scaled-and-zoomed="0" data-lt-scroll-left-scaled-and-zoomed="0" style="border: 1px solid rgb(206, 212, 218) !important; border-radius: 4px !important; direction: ltr !important; font: 400 16px / 1.5 system-ui, -apple-system, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, &quot;Noto Sans&quot;, &quot;Liberation Sans&quot;, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;, &quot;Noto Color Emoji&quot; !important; font-feature-settings: normal !important; font-kerning: auto !important; font-synthesis: weight style small-caps !important; hyphens: manual !important; letter-spacing: normal !important; line-break: auto !important; margin: 0px !important; padding: 6px 12px !important; text-align: start !important; text-decoration: none solid rgb(33, 37, 41) !important; text-indent: 0px !important; text-rendering: auto !important; text-transform: none !important; transform: none !important; transform-origin: 348px 31px !important; unicode-bidi: normal !important; white-space: pre-wrap !important; word-spacing: 0px !important; overflow-wrap: break-word !important; writing-mode: horizontal-tb !important; zoom: 1 !important; -webkit-locale: &quot;en&quot; !important; -webkit-rtl-ordering: logical !important; width: 670px !important; height: 48px !important;"><lt-div class="lt-mirror__canvas" style="margin-top: 0px !important; margin-left: 0px !important; width: 670px !important; height: 48px !important;"></lt-div></lt-div></lt-mirror><textarea name="content" cols="40" rows="2" class="form-control shadow-none" placeholder="Add a public comment..." maxlength="2000" required="" id="id_content" data-lt-tmp-id="lt-883410" spellcheck="false" data-gramm="false"></textarea></p> \
              <input type="hidden" name="csrfmiddlewaretoken" value="' + csrf_token + '"> \
              <button type="submit" class="btn btn-primary btn-block float-end px-4 shadow-none">Post</button> \
              <button type="button" class="btn btn-secondary btn-block float-end px-4 mx-2 shadow-none" onclick="closeCommentForm()">Cancel</button> \
        </form>');
    }

    function closeCommentForm() {
      document.getElementById('commentForm').remove();
    }
   </script>

  <!-- comments pagination -->
<div class="py-4">
  <nav aria-label="Page navigation example">
      {% if page_obj.has_other_pages %}
      <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == l %}
        <li class="page-item active"><span class="page-link">{{ num }} <span class="sr-only">(current)</span></span>
        </li>
        {% else %}
        <li><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
        {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        {% else %}
        <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
        {% endif %}
      </ul>
      {% endif %}
  </nav>
</div>
{% endif %}

{% endblock %}
